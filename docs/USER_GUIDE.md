# User Guide - Meningioma FTIR Classification Pipeline

**Version 4.0** | October 2025

This guide provides complete instructions for using the unified FTIR meningioma classification pipeline.

---

## Table of Contents

1. [Quick Start](#quick-start)
2. [Pipeline Overview](#pipeline-overview)
3. [Installation](#installation)
4. [Basic Usage](#basic-usage)
5. [Advanced Options](#advanced-options)
6. [Understanding Results](#understanding-results)
7. [Troubleshooting](#troubleshooting)
8. [Migration from v3.x](#migration-from-v3x)

---

## Quick Start

### First Time Setup

```matlab
% 1. Navigate to project directory
cd 'c:\Users\Franz\OneDrive\01_Promotion\01 Data\new-pipeline'

% 2. Add pipeline to MATLAB path
addpath('src/meningioma_ftir_pipeline');

% 3. Run complete pipeline
run_pipeline()
```

### Subsequent Runs

```matlab
% Skip EDA if already done (saves time)
run_pipeline('RunEDA', false)

% Quick test with fewer CV iterations
run_pipeline('RunEDA', false, 'NFolds', 3, 'NRepeats', 10)
```

---

## Pipeline Overview

The pipeline consists of four main steps:

### Step 1: Exploratory Data Analysis (EDA)
- Loads training data only
- Performs PCA (5 components for visualization, 15 for classification)
- Detects outliers using T² and Q statistics
- **Output**: `results/eda/eda_results_PP1.mat` + visualization plots

### Step 2: Data Loading & Quality Filtering
- Loads train and test data tables
- Applies EDA outlier filtering to training set
- Keeps all test set spectra (no filtering)
- Packages PCA model for downstream use
- **Output**: Data structure in memory

### Step 3: Cross-Validation
- Patient-stratified k-fold CV (default: 5 folds, 50 repeats)
- Tests 4 classifiers: LDA, PLS-DA, SVM-RBF, Random Forest
- Hyperparameter optimization via Bayesian search
- **Output**: Performance metrics, predictions per sample/patient

### Step 4: Results Export
- Excel file with detailed predictions
- Text summary with mean ± std metrics
- MATLAB structure for further analysis
- **Output**: `results/meningioma_ftir_pipeline/run_TIMESTAMP/`

---

## Installation

### Prerequisites

1. **MATLAB** R2019b or later
2. **Required Toolboxes**:
   - Statistics and Machine Learning Toolbox
   - Optimization Toolbox (for hyperparameter tuning)

### Setup

```matlab
% Clone or download repository
cd 'path/to/new-pipeline'

% Add to MATLAB path (or add to startup.m)
addpath('src/meningioma_ftir_pipeline');
addpath('src/utils');

% Verify installation
which run_pipeline
% Should show: ...new-pipeline/src/meningioma_ftir_pipeline/run_pipeline.m
```

### Data Requirements

Your `data/` folder must contain:
- `data_table_train.mat` - Training data table
- `data_table_test.mat` - Test data table  
- `wavenumbers.mat` - Wavenumber values

These are generated by `split_train_test.m`.

---

## Basic Usage

### Run Complete Pipeline

```matlab
% Default: EDA + CV (5 folds, 50 repeats) + Export
run_pipeline()
```

This takes approximately:
- EDA: 3-5 minutes
- CV: 15-30 minutes (depends on hyperparameter optimization)
- **Total**: ~20-35 minutes

### Run Without EDA

If you've already run EDA once:

```matlab
run_pipeline('RunEDA', false)
```

This saves 3-5 minutes per run.

### Quick Test Run

For testing or development:

```matlab
% 3 folds, 10 repeats (~3-5 minutes)
run_pipeline('RunEDA', false, 'NFolds', 3, 'NRepeats', 10)

% Single classifier test
run_pipeline('RunEDA', false, 'Classifiers', {'SVM'}, 'NFolds', 3, 'NRepeats', 5)
```

---

## Advanced Options

### All Available Options

```matlab
run_pipeline(...
    'RunEDA', true, ...           % Run EDA step (default: true)
    'OutlierMethod', 'eda', ...   % 'eda', 'qc', or 'none' (default: 'eda')
    'Classifiers', {...}, ...     % Cell array of classifiers
    'NFolds', 5, ...              % Number of CV folds (default: 5)
    'NRepeats', 50, ...           % Number of CV repeats (default: 50)
    'Verbose', true, ...          % Display detailed output (default: true)
    'SaveResults', true ...       % Save results to disk (default: true)
)
```

### Outlier Detection Methods

**Option 1: EDA-based (Recommended)**
```matlab
run_pipeline('OutlierMethod', 'eda')  % Default
```
- Uses T² and Q statistics
- Most statistically rigorous
- Requires `run_eda()` first

**Option 2: Legacy QC**
```matlab
run_pipeline('OutlierMethod', 'qc', 'RunEDA', false)
```
- Uses old quality control system
- Requires `quality_control_analysis()` first
- For backward compatibility only

**Option 3: No Filtering**
```matlab
run_pipeline('OutlierMethod', 'none', 'RunEDA', false)
```
- Uses all spectra without filtering
- Useful for comparison studies

### Classifier Selection

Test specific classifiers:

```matlab
% Single classifier
run_pipeline('Classifiers', {'SVM'})

% Subset of classifiers
run_pipeline('Classifiers', {'LDA', 'SVM'})

% All classifiers (default)
run_pipeline('Classifiers', {'LDA', 'PLSDA', 'SVM', 'RandomForest'})
```

### Capture Results

```matlab
% Save results to variable
results = run_pipeline('RunEDA', false);

% Access CV results
cv_results = results.cv_results;

% Get best classifier performance
svm_metrics = cv_results.SVM.metrics;
fprintf('SVM Accuracy: %.3f ± %.3f\n', ...
        svm_metrics.accuracy_mean, svm_metrics.accuracy_std);
```

---

## Understanding Results

### Output Directory Structure

```
results/meningioma_ftir_pipeline/run_YYYYMMDD_HHMMSS/
├── cv_results.mat           # MATLAB structure with all results
├── cv_summary.txt           # Text summary (mean ± std)
└── cv_predictions.xlsx      # Excel file (one sheet per classifier)
```

### Excel File Format

Each classifier has a separate sheet with columns:
- `Sample_ID`: Diss_ID (probe identifier)
- `Patient_ID`: Patient identifier
- `True_Label`: Actual WHO grade (1 or 3)
- `Predicted_Label`: Model prediction (1 or 3)
- `Correct`: TRUE if prediction matches actual
- `Confidence`: Prediction confidence (if available)

### Performance Metrics

**Accuracy**: Overall correctness  
**Sensitivity**: True positive rate (WHO-3 detection)  
**Specificity**: True negative rate (WHO-1 detection)  
**Precision**: Positive predictive value  
**F1-Score**: Harmonic mean of precision and sensitivity  
**AUC**: Area under ROC curve

---

## Troubleshooting

### Error: "Training data file not found"

**Problem**: Missing `data_table_train.mat`

**Solution**:
```matlab
% Generate train/test split first
split_train_test(dataset_men);
```

### Error: "EDA results not found"

**Problem**: Trying to use `OutlierMethod='eda'` without running EDA

**Solution**:
```matlab
% Run EDA first
run_eda()

% Or use different outlier method
run_pipeline('OutlierMethod', 'none', 'RunEDA', false)
```

### Warning: "Optimization failed"

**Problem**: Bayesian optimization encountered issues

**Impact**: Falls back to default hyperparameters

**Solution**: This is usually okay. The pipeline continues with reasonable defaults.

### Out of Memory Errors

**Problem**: Dataset too large for available RAM

**Solutions**:
```matlab
% 1. Reduce CV repeats
run_pipeline('NRepeats', 10)

% 2. Test fewer classifiers
run_pipeline('Classifiers', {'SVM'})

% 3. Close other programs to free RAM
```

### Slow Performance

**Typical Durations**:
- EDA: 3-5 minutes
- CV (5 folds, 50 repeats): 15-30 minutes

**To Speed Up**:
```matlab
% Reduce CV iterations
run_pipeline('NFolds', 3, 'NRepeats', 10)

% Disable hyperparameter optimization in config.m
cfg = config();
cfg.optimization.enabled = false;
```

---

## Migration from v3.x

### Old vs New Function Names

| Old (v3.x) | New (v4.0) | Notes |
|------------|------------|-------|
| `run_pipeline_direct()` | `run_pipeline()` | Main entry point |
| `run_pipeline_with_eda()` | `run_pipeline()` | Now the default |
| `run_full_eda()` | `run_eda()` | Simplified interface |
| `load_data_direct()` | `load_pipeline_data()` | Unified loader |
| `load_data_with_eda()` | `load_pipeline_data()` | Merged functionality |
| `test_direct_pipeline()` | Moved to `tests/` | Still available |

### Migration Examples

```matlab
% OLD (v3.x)
run_pipeline_direct(true)

% NEW (v4.0)
run_pipeline('OutlierMethod', 'qc')

% ------------------------------

% OLD (v3.x)
run_full_eda()
run_pipeline_with_eda()

% NEW (v4.0)
run_pipeline()  % EDA is run automatically

% ------------------------------

% OLD (v3.x)
data = load_data_with_eda(cfg);

% NEW (v4.0)
data = load_pipeline_data(cfg, 'OutlierMethod', 'eda');
```

### What's Changed

1. **Unified Entry Point**: One `run_pipeline()` function instead of multiple variants
2. **Automatic EDA**: EDA runs by default (can be skipped with `RunEDA=false`)
3. **Flexible Outlier Methods**: Choose between EDA, QC, or none
4. **Better Organization**: Tests in `tests/`, utilities in `src/utils/`
5. **Deprecation Warnings**: Old functions still work but display warnings

### Backward Compatibility

All v3.x functions still work with deprecation warnings:

```matlab
% This still works but shows a warning
run_pipeline_direct(true)

% Output:
% ⚠️ DEPRECATION WARNING
% This function is deprecated. Please use:
% >> run_pipeline('OutlierMethod', 'qc')
```

---

## Next Steps

- **[API Reference](API_REFERENCE.md)** - Detailed function documentation
- **[Development Guide](DEVELOPMENT.md)** - Development history and design decisions
- **[GitHub Issues](https://github.com/raketenronny1/new-pipeline/issues)** - Report bugs or request features

---

**Last Updated**: October 24, 2025  
**Version**: 4.0  
**Author**: FTIR Meningioma Classification Team
